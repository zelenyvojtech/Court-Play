{% extends "base.html" %}

{% block title %}Rezervace | Kalendář{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', path='css/reservations_calendar.css') }}">

<section class="resv-page">
  <header class="resv-top">
    <div>
      <h2 class="resv-title">Kalendář kurtů</h2>
      <p class="resv-sub">Klikni na čas pro rezervaci.</p>

      <div class="resv-legend">
        <span class="legend-item"><i class="dot dot-free"></i> Volno</span>
        <span class="legend-item"><i class="dot dot-busy"></i> Obsazeno</span>
        <span class="legend-item"><i class="dot" style="background:#22c55e"></i> Moje</span>
      </div>
    </div>

    <form id="filtersForm" method="get" class="resv-filters">
      <div class="pill">
        <label for="date">Datum</label>
        <input id="date" name="date" type="date" value="{{ selected_date }}" onchange="this.form.submit()">
      </div>

      <div class="pill">
        <label for="duration">Délka</label>
        <select id="duration" name="duration" onchange="this.form.submit()">
          <option value="60" {% if duration == 60 %}selected{% endif %}>60 min</option>
          <option value="90" {% if duration == 90 %}selected{% endif %}>90 min</option>
          <option value="120" {% if duration == 120 %}selected{% endif %}>120 min</option>
        </select>
      </div>

      <div class="pill">
        <label for="env">Povrch</label>
        <select id="env" name="env" onchange="this.form.submit()">
          <option value="all" {% if environment == "all" %}selected{% endif %}>Vše</option>
          <option value="indoor" {% if environment == "indoor" %}selected{% endif %}>Indoor</option>
          <option value="outdoor" {% if environment == "outdoor" %}selected{% endif %}>Outdoor</option>
        </select>
      </div>

      <noscript>
         <button class="btn btn--ghost">Aktualizovat</button>
      </noscript>
    </form>
  </header>

  {% if flash_error %}
    <div class="hint" style="background:#fee2e2; color:#991b1b;">{{ flash_error }}</div>
  {% elif flash_ok %}
    <div class="hint" style="background:#dcfce7; color:#166534;">{{ flash_ok }}</div>
  {% endif %}

  <div class="resv-card">
      <div class="cal-scroll">
        <div class="cal-grid" style="grid-template-columns: 80px repeat({{ courts|length }}, minmax(140px, 1fr));">

          <div class="cell head corner">Čas</div>
          {% for court in courts %}
            <div class="cell head">
              <div class="court-head">
                <div class="court-name">{{ court.court_name }}</div>
                <div class="court-meta">{{ "Outdoor" if court.outdoor else "Indoor" }}</div>
              </div>
            </div>
          {% endfor %}

          {% for slot in time_slots %}
            <div class="cell time">{{ slot }}</div>

            {% for court in courts %}
              {% set cell = grid[court.courts_id|string].get(slot) %}
              <div class="cell">
                {% if cell %}
                   <div class="slot
                        {% if cell.status == 'blocked' %}is-blocked
                        {% elif cell.status == 'past' %}is-past
                        {% elif cell.status == 'mine' %}
                        {% else %}is-busy{% endif %}"
                        {% if cell.status == 'mine' %}style="background:#22c55e; color:white;"{% endif %}>
                      {% if cell.label != "—" %}{{ cell.label }}{% endif %}
                   </div>
                {% else %}
                   <a href="{{ url_for('reservation_confirm_ui') }}?court_id={{ court.courts_id }}&start={{ selected_date }}T{{ slot }}&duration={{ duration }}"
                      class="slot slot-free" title="Rezervovat">
                      +
                   </a>
                {% endif %}
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      </div>
  </div>
</section>
{% endblock %}